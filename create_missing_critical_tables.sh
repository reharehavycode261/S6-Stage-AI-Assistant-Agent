#!/bin/bash
# ========================================================================
# CRÃ‰ATION DES TABLES CRITIQUES MANQUANTES
# ========================================================================

set -e

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "ğŸ”§ CRÃ‰ATION DES TABLES CRITIQUES MANQUANTES"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

echo "ğŸ“Š Tables critiques Ã  crÃ©er:"
echo "   1. ai_cost_tracking (tracking dÃ©taillÃ© des coÃ»ts IA)"
echo "   2. ai_prompt_templates (templates de prompts)"
echo "   3. ai_prompt_usage (usage des prompts)"
echo "   4. task_update_triggers (triggers de mise Ã  jour)"
echo ""

# VÃ©rifier que Docker est lancÃ©
if ! docker ps | grep -q "ai_agent_postgres"; then
    echo "âŒ Le conteneur PostgreSQL n'est pas dÃ©marrÃ©"
    exit 1
fi

echo "âœ… Conteneur PostgreSQL dÃ©tectÃ©"
echo ""

# Ã‰tape 1: CrÃ©er schema_complet_ai_agent pour avoir ai_cost_tracking
echo "ğŸ“¦ Ã‰tape 1: CrÃ©ation de ai_cost_tracking"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
docker exec -i ai_agent_postgres psql -U admin -d ai_agent_admin <<'EOF'
-- CrÃ©er uniquement ai_cost_tracking si elle n'existe pas
CREATE TABLE IF NOT EXISTS ai_cost_tracking (
    ai_cost_tracking_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    task_id BIGINT REFERENCES tasks(tasks_id) ON DELETE CASCADE,
    task_run_id BIGINT REFERENCES task_runs(tasks_runs_id) ON DELETE CASCADE,
    provider VARCHAR(50) NOT NULL,
    model VARCHAR(100) NOT NULL,
    operation_type VARCHAR(50),
    prompt_tokens INTEGER NOT NULL,
    completion_tokens INTEGER NOT NULL,
    total_tokens INTEGER NOT NULL,
    cost_usd NUMERIC(12,6) NOT NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_ai_cost_task ON ai_cost_tracking(task_id);
CREATE INDEX IF NOT EXISTS idx_ai_cost_run ON ai_cost_tracking(task_run_id);
CREATE INDEX IF NOT EXISTS idx_ai_cost_provider_date ON ai_cost_tracking(provider, created_at DESC);

COMMENT ON TABLE ai_cost_tracking IS 'Tracking des coÃ»ts d''utilisation des API IA';

\echo 'âœ… Table ai_cost_tracking crÃ©Ã©e'
EOF

# Ã‰tape 2: CrÃ©er les tables conversationnelles
echo ""
echo "ğŸ“¦ Ã‰tape 2: CrÃ©ation des tables conversationnelles (prompts, etc.)"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
docker exec -i ai_agent_postgres psql -U admin -d ai_agent_admin < data/migration_conversational_features.sql 2>&1 | grep -E "CREATE TABLE|ERROR|âœ…" || echo "âœ… Migration conversationnelle appliquÃ©e"

# Ã‰tape 3: CrÃ©er task_update_triggers
echo ""
echo "ğŸ“¦ Ã‰tape 3: CrÃ©ation de task_update_triggers"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
docker exec -i ai_agent_postgres psql -U admin -d ai_agent_admin < data/migration_task_update_triggers.sql 2>&1 | grep -E "CREATE TABLE|ERROR|âœ…" || echo "âœ… Table task_update_triggers crÃ©Ã©e"

# Ã‰tape 4: VÃ©rification finale
echo ""
echo "ğŸ“¦ Ã‰tape 4: VÃ©rification des tables crÃ©Ã©es"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
docker exec ai_agent_postgres psql -U admin -d ai_agent_admin -c "
SELECT 
    tablename,
    CASE 
        WHEN tablename IN ('ai_cost_tracking', 'ai_prompt_templates', 'ai_prompt_usage', 'task_update_triggers') 
        THEN 'âœ… NOUVELLE TABLE CRITIQUE'
        ELSE 'ğŸ“Š Existante'
    END as status
FROM pg_tables 
WHERE schemaname = 'public'
AND tablename IN ('ai_cost_tracking', 'ai_prompt_templates', 'ai_prompt_usage', 'task_update_triggers', 'task_context_memory')
ORDER BY tablename;
"

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "âœ… CRÃ‰ATION TERMINÃ‰E"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "ğŸ” Relancer la vÃ©rification complÃ¨te:"
echo "   ./venv/bin/python verify_all_tables.py"
echo ""

